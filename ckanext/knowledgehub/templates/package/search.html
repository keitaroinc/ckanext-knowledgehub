{% resource 'knowledgehub/table' %}
{% resource 'knowledgehub/chart' %}
{% resource 'knowledgehub/javascript/modules/render_homepage_results.js' %}


{% extends "page.html" %}
{% import 'macros/form.html' as form %}

{% block subtitle %}{{ _("Datasets") }}{% endblock %}

{% block breadcrumb_content %}
{% endblock %}

{% block content %}
{% set rqs = h.get_rq(6, 'modified_at  desc').get('data', []) %}
<div class="container-fluid rq-section">
    <div class="row flex flex-wrap">
        {% for rq in rqs %}
        <div class="col-lg-2 rq-box rq-item"
            style="flex: 1;background:linear-gradient(0deg,rgba(4, 114, 187, 0.75),rgba(4, 114, 187, 0.75)), url({{ rq.get('image_url') }}); background-blend-mode: multiply; background-size: cover;">
            <h3 class="rq-heading text-wrap">
                <a href="{% url_for 'research_question.read', name=rq.get('name') %}">{{ rq.get('title') }}</a>
                <small>Research Question</small>
            </h3>

        </div>
        {% endfor %}
    </div>
</div>
<section class="module home-content">
    <div class="module-content search-box-wrapper">

        {% block form %}
        {% set facets = {
          'fields': c.fields_grouped,
          'search': c.search_facets,
          'titles': c.facet_titles,
          'translated_fields': c.translated_fields,
          'remove_field': c.remove_field }
        %}
        {% set sorting = [
          (_('Relevance'), 'score desc, metadata_modified desc'),
          (_('Name Ascending'), 'title_string asc'),
          (_('Name Descending'), 'title_string desc'),
          (_('Last Modified'), 'metadata_modified desc'),
          (_('Popular'), 'views_recent desc') if g.tracking_enabled else (false, false) ]
        %}

        <div class="container-fluid big-search-box">
            <div class="row">
                <div class="col-lg-6 col-lg-offset-3">
                    {% snippet 'snippets/search_form.html', form_id='dataset-search-form', type=dataset_type, query=c.q, sorting=sorting, sorting_selected=c.sort_by_selected, count=c.page.item_count, placeholder=_('Start typing you question here') + '...', facets=facets, show_empty=request.params, error=c.query_error, fields=c.fields %}
                </div>
            </div>
        </div>
        {% endblock %}
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1">
                <div class="row">
                    <div class="col-lg-3 group-list secondary dashboards">
                        <h4>DASHBOARDS</h4>
                        {% set found_dashboards = h.get_dashboards(limit=4, order_by='created_at desc') %}
                        <hr>
                        <ul class="list-unstyled nav nav-simple">
                            {% if found_dashboards %}
                            {% for dashboard in found_dashboards %}
                            <li class="nav-item">
                                <a class="dashboard-link"
                                    href="{{  h.url_for('dashboards.view', name=dashboard.name) }}">
                                    <div>
                                        <h4>{{dashboard.title}}</h4>
                                        {% set truncate = truncate or 180 %}
                                        {% set truncate_description = truncate_description or 150 %}
                                        {% set description = dashboard['description'] %}
                                        <p class="text-muted">
                                            <small>{{ h.truncate(description, truncate_description) }}</small></p>
                                        <div class="dashboard-created">
                                            <i class="fa fa-table"></i>
                                            {{ dashboard.created_at.strftime('%Y-%m-%d')  }}
                                        </div>
                                    </div>
                                </a>
                            </li>
                            {% endfor %}
                            {% else %}
                            <li class="nav-item">
                                <div>
                                    {{_('No Dashboards have been created.')}}
                                    <span class="btn btn-link">
                                        {{ h.nav_link(_('Create new Dashboard now'), named_route='dashboards.new', icon='angle-double-right') }}
                                    </span>
                                </div>
                            </li>
                            {% endif %}
                        </ul>
                        {% if found_dashboards %}
                        <div class="btn btn-link">
                            {{ h.nav_link(_('View All Dashboards'), named_route='dashboards.index', icon='angle-double-right') }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-lg-7 group-list indicators">
                        <div class="group-list-items">
                            <button class="group-list-items" onclick="showSearchResults(event, 'package_list')">DATASETS</button>
                            <button class="group-list-items" id="search_rq_button" onclick="showSearchResults(event, 'hidden_rqs')">RESEARCH QUESTIONS</button>
                            
                            <button class="group-list-items" onclick="showSearchResults(event, 'hidden_dashs')">DASHBOARDS</button>
                            
                            <button class="group-list-items" onclick="showSearchResults(event, 'hidden_visuals')"> VISUALIZATIONS</button>
                            
                            <hr>
                            {% block page_primary_action %}
                            {% if h.check_access('package_create') %}
                            <div class="page_primary_action">
                                {{ h.snippet ('snippets/add_dataset.html', dataset_type=dataset_type) }}
                            </div>
                            {% endif %}
                            {% endblock %}
                        </div>

                        {% block package_search_results_list %}
                        <div id="package_list" class="tab_content">
                            {{ h.snippet('snippets/package_list.html', packages=c.page.items) }}
                        </div>
                        <div id="hidden_rqs" style="display: none" class="tab_content">
                            {% if c.q %}
                            {% if h.get_searched_rqs(c.q) %}
                            {% set rqs = h.get_searched_rqs(c.q) %}
                            <div class="container-fluid rq-section">
                                <div class="row flex flex-wrap">
                                    {% for rq in rqs %}
                                    <div class="col-lg-2 rq-box rq-item"
                                        style="flex: 1;background:linear-gradient(0deg,rgba(4, 114, 187, 0.75),rgba(4, 114, 187, 0.75)), url({{ rq.get('image_url') }}); background-blend-mode: multiply; background-size: cover;">
                                        <h3 class="rq-heading text-wrap">
                                            <a href="{% url_for 'research_question.read', name=rq.get('name') %}">{{ rq.get('title') }}</a>
                                            <small>Research Question</small>
                                        </h3>                            
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% else %}
                            {{_('There are no research questions found for the selected query.') }}
                            {% endif %}
                            
                            {% endif %}
                        </div>

                        <div id = "hidden_visuals" style="display: none" class="tab_content">
                            {% if c.q %}
                            {% if h.get_searched_visuals(c.q) %}
                            <div class="col-lg-12 visualizations">
                                <div class="visualization-wrapper">
                                    <div class="resource-view">
                                        {% set vis = h.get_searched_visuals(c.q) %}
                                        {% for resource_view in vis %}
                                        {% if resource_view.view_type == 'chart' %}
                                        {% set chart_id = resource_view.id %}
                                        {% if resource_view.__extras %}
                                        {% set colors = resource_view.__extras.color %}
                                        {% set x_axis = resource_view.__extras.x_axis %}
                                        {% set y_axis = resource_view.__extras.y_axis %}
                                        {% set additional_tornado_value = resource_view.__extras.additional_tornado_value %}
                                        {% set chart_type = resource_view.__extras.type %}
                                        {% set title = resource_view.title %}
                                        {% set chart_subtitle = resource_view.__extras.chart_subtitle %}
                                        {% set chart_description = resource_view.__extras.chart_description %}
                                        {% set show_legend = resource_view.__extras.show_legend %}
                                        {% set x_text_rotate = resource_view.__extras.x_text_rotate %}
                                        {% set x_text_multiline = resource_view.__extras.x_text_multiline %}
                                        {% set tooltip_name = resource_view.__extras.tooltip_name %}
                                        {% set data_format = resource_view.__extras.data_format %}
                                        {% set y_tick_format = resource_view.__extras.y_tick_format %}
                                        {% set chart_padding_left = resource_view.__extras.chart_padding_left %}
                                        {% set chart_padding_bottom = resource_view.__extras.chart_padding_bottom %}
                                        {% set padding_bottom = resource_view.__extras.padding_bottom %}
                                        {% set padding_top = resource_view.__extras.padding_top %}
                                        {% set tick_count = resource_view.__extras.tick_count %}
                                        {% set show_labels = resource_view.__extras.show_labels %}
                                        {% set y_label = resource_view.__extras.y_label %}
                                        {% set y_from_zero = resource_view.__extras.y_from_zero %}
                                        {% set data_sort = resource_view.__extras.sort %}
                                        {% set filters = resource_view.__extras.filters %}
                                        {% set category_name = resource_view.__extras.category_name %}
                                        {% set dynamic_reference_type = resource_view.__extras.dynamic_reference_type %}
                                        {% set dynamic_reference_factor = resource_view.__extras.dynamic_reference_factor %}
                                        {% set dynamic_reference_label = resource_view.__extras.dynamic_reference_label %}
                                        {% set sql_string = resource_view.__extras.sql_string %}
                                        {% endif %}
                                        {% snippet 'ajax_snippets/chart_module.html',
                                                        type='chart',
                                                        chart_id = chart_id,
                                                        colors=colors,
                                                        x_axis=x_axis,
                                                        y_axis=y_axis,
                                                        additional_tornado_value = additional_tornado_value,
                                                        chart_type=chart_type,
                                                        sql_string=sql_string,
                                                        title=title,
                                                        chart_subtitle=chart_subtitle,
                                                        chart_description=chart_description,
                                                        show_legend = show_legend,
                                                        x_text_rotate= 0,
                                                        x_text_multiline= x_text_multiline,
                                                        tooltip_name = tooltip_name,
                                                        data_format = data_format,
                                                        y_tick_format = y_tick_format,
                                                        chart_padding_left = chart_padding_left,
                                                        chart_padding_bottom = chart_padding_bottom,
                                                        padding_bottom = padding_bottom,
                                                        padding_top = padding_top,
                                                        tick_count = tick_count,
                                                        show_labels = show_labels,
                                                        y_label = y_label,
                                                        y_from_zero = y_from_zero,
                                                        data_sort = data_sort,
                                                        filters = filters,
                                                        category_name=category_name,
                                                        measure_label=measure_label,
                                                        dynamic_reference_type=dynamic_reference_type,
                                                        dynamic_reference_factor=dynamic_reference_factor,
                                                        dynamic_reference_label=dynamic_reference_label
                                                    %}
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            {{ "There are no visualizations found for the selected query. "}}
                            {% endif %}
                            {% endif %}
                            </div>
                            <div id = "hidden_dashs" style="display: none" class="tab_content">
                                {% if c.q %}
                                {% if h.get_searched_dashboards(c.q) %}
                                {% set dashes = h.get_searched_dashboards(c.q) %}
                                {% for dashboard in dashes %}
                                    <a class="dashboard-link"
                                        href="{{  h.url_for('dashboards.view', name=dashboard.name) }}">
                                        <div>
                                            <h4>{{dashboard.title}}</h4>
                                        </div>
                                    </a>
                                {% endfor %}
                                {% else %}
                                {{_('There are no dashboards found for the selected query.') }}
                                {% endif %}                             

                                {% endif %}
                            </div>
                    {% endblock %}
                </div>




                    {% block secondary_content %}
                    <div class="filters col-lg-2" id="filter">
                        <div>
                            {% for facet in c.facet_titles %}
                            {{ h.snippet('snippets/facet_list.html', title=c.facet_titles[facet], name=facet) }}
                            {% endfor %}
                        </div>
                        <a class="close no-text hide-filters"><i class="fa fa-times-circle"></i><span
                                class="text">close</span></a>
                    </div>
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    {% block page_pagination %}
    {{ c.page.pager(q=c.q) }}
    {% endblock %}
</section>

{% block package_search_results_api %}
{% endblock %}
<div class="container-fluid visualization-section">
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1 title">
            <h4>VISUALIZATIONS</h4>
            <hr>
        </div>
        {% if h.get_last_visuals() %}
        <div class="col-lg-10 col-lg-offset-1 visualizations">
            <div class="visualization-wrapper">
                <div class="row justify-content-md-center resource-view">
                    {% set vis = h.get_last_visuals() %}
                    {% for resource_view in vis %}
                    <div class="col-lg-3">
                        {% if resource_view.view_type == 'chart' %}
                        {% set chart_id = resource_view.id %}
                        {% if resource_view.__extras %}
                        {% set colors = resource_view.__extras.color %}
                        {% set x_axis = resource_view.__extras.x_axis %}
                        {% set y_axis = resource_view.__extras.y_axis %}
                        {% set additional_tornado_value = resource_view.__extras.additional_tornado_value %}
                        {% set chart_type = resource_view.__extras.type %}
                        {% set title = resource_view.title %}
                        {% set chart_subtitle = resource_view.__extras.chart_subtitle %}
                        {% set chart_description = resource_view.__extras.chart_description %}
                        {% set show_legend = resource_view.__extras.show_legend %}
                        {% set x_text_rotate = resource_view.__extras.x_text_rotate %}
                        {% set x_text_multiline = resource_view.__extras.x_text_multiline %}
                        {% set tooltip_name = resource_view.__extras.tooltip_name %}
                        {% set data_format = resource_view.__extras.data_format %}
                        {% set y_tick_format = resource_view.__extras.y_tick_format %}
                        {% set chart_padding_left = resource_view.__extras.chart_padding_left %}
                        {% set chart_padding_bottom = resource_view.__extras.chart_padding_bottom %}
                        {% set padding_bottom = resource_view.__extras.padding_bottom %}
                        {% set padding_top = resource_view.__extras.padding_top %}
                        {% set tick_count = resource_view.__extras.tick_count %}
                        {% set show_labels = resource_view.__extras.show_labels %}
                        {% set y_label = resource_view.__extras.y_label %}
                        {% set y_from_zero = resource_view.__extras.y_from_zero %}
                        {% set data_sort = resource_view.__extras.sort %}
                        {% set filters = resource_view.__extras.filters %}
                        {% set category_name = resource_view.__extras.category_name %}
                        {% set dynamic_reference_type = resource_view.__extras.dynamic_reference_type %}
                        {% set dynamic_reference_factor = resource_view.__extras.dynamic_reference_factor %}
                        {% set dynamic_reference_label = resource_view.__extras.dynamic_reference_label %}
                        {% set sql_string = resource_view.__extras.sql_string %}
                        {% endif %}
                        {% snippet 'ajax_snippets/chart_module.html',
                                    type='chart',
                                    chart_id = chart_id,
                                    colors=colors,
                                    x_axis=x_axis,
                                    y_axis=y_axis,
                                    additional_tornado_value = additional_tornado_value,
                                    chart_type=chart_type,
                                    sql_string=sql_string,
                                    title=title,
                                    chart_subtitle=chart_subtitle,
                                    chart_description=chart_description,
                                    show_legend = show_legend,
                                    x_text_rotate= 0,
                                    x_text_multiline= x_text_multiline,
                                    tooltip_name = tooltip_name,
                                    data_format = data_format,
                                    y_tick_format = y_tick_format,
                                    chart_padding_left = chart_padding_left,
                                    chart_padding_bottom = chart_padding_bottom,
                                    padding_bottom = padding_bottom,
                                    padding_top = padding_top,
                                    tick_count = tick_count,
                                    show_labels = show_labels,
                                    y_label = y_label,
                                    y_from_zero = y_from_zero,
                                    data_sort = data_sort,
                                    filters = filters,
                                    category_name=category_name,
                                    measure_label=measure_label,
                                    dynamic_reference_type=dynamic_reference_type,
                                    dynamic_reference_factor=dynamic_reference_factor,
                                    dynamic_reference_label=dynamic_reference_label
                                %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class=" col-lg-10 col-lg-offset-1">
            <div class="no-items"> There are no visualizations created yet.</div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
