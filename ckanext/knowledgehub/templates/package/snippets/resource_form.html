{% import 'macros/form.html' as form %}

{% resource 'knowledgehub/javascript/data_sources.js' %}
{% resource 'knowledgehub/javascript/list_subthemes_for_theme.js' %}
{% set data = data or {} %}
{% set errors = errors or {} %}
{% set action = form_action or h.url_for(controller='package', action='new_resource', id=pkg_name) %}
{% set theme_options = h.get_theme_options() %}

<form id="resource-edit" class="dataset-form dataset-resource-form" method="post" action="{{ action }}" data-module="basic-form resource-form" enctype="multipart/form-data" novalidate>

  {% block stages %}
    {# An empty stages variable will not show the stages #}
    {% if stage %}
      {{ h.snippet('package/snippets/stages.html', stages=stage, pkg_name=pkg_name) }}
    {% endif %}
  {% endblock %}

  {% block errors %}{{ form.errors(error_summary) }}{% endblock %}

  <input name="id" value="{{ data.id }}" type="hidden"/>
  <input id="form-data" value="{{ data }}" type="hidden"/>
  <input id="form-errors" value="{{ errors }}" type="hidden"/>

  {% block basic_fields %}
    {% block basic_fields_url %}
      {% set is_upload = (data.url_type == 'upload') %}
      {{ form.image_upload(data, errors, field_url='url', field_upload='upload', field_clear='clear_upload',
         is_upload_enabled=h.uploads_enabled(), is_url=data.url and not is_upload, is_upload=is_upload,
         upload_label=_('Data'), url_label=_('URL'), placeholder=_('http://example.com/external-data.csv'), field_name='name') }}
         <div class="input-group-btn">
            <button class="btn btn-default btn-data-source" type="button"><i class="fa fa-database"></i>{{ _('Source') }}</button>
        </div>
    {% endblock %}
    <div class="data-source">
      <div class="select-form"></div>
      <div class="connection-params"></div>
    </div>
    {% block basic_fields_name %}
      {{ form.input('name', id='field-name', label=_('Name'), placeholder=_('eg. January 2011 Gold Prices'), value=data.name, error=errors.name, classes=['control-full']) }}
    {% endblock %}

    {% block basic_fields_description %}
      {{ form.markdown('description', id='field-description', label=_('Description'), placeholder=_('Some useful notes about the data'), value=data.description, error=errors.description) }}
    {% endblock %}

    {% block basic_fields_format %}
      {% set format_attrs = {'data-module': 'autocomplete', 'data-module-source': '/api/2/util/resource/format_autocomplete?incomplete=?'} %}
      {% call form.input('format', id='field-format', label=_('Format'), placeholder=_('eg. CSV, XML or JSON'), value=data.format, error=errors.format, classes=['control-medium'], attrs=format_attrs) %}
        <span class="info-block info-block-small">
          <i class="fa fa-info-circle"></i>
          {{ _('This will be guessed automatically. Leave blank if you wish') }}
        </span>
      {% endcall %}
    {% endblock %}

<!--
    {% block basic_fields_subject_name %}
	{{ form.input('subject_name', id='field-sub-name', label=_('Subject Name'), placeholder=_('e.g. Giorgia'), value=data.sub_name, error=errors.sub_name, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_worker_title %}
	{{ form.input('worker_title', id='field-worker-title', label=_('Title'), placeholder=_('e.g. Information Management Officer'), value=data.worker_title, error=errors.worker_title, classes=['control-full'], is_required=False) }}
    {% endblock %}
-->
    {% block basic_fields_unit_supported %}
	{{ form.input('unit_supported', id='field-unit-supported', label=_('Unit Supported'), placeholder=_('e.g. Protection'), value=data.unit_supported, error=errors.unit_supported, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_im_product_name %}
	{{ form.input('im_product_name', id='field-im-product-name', label=_('IM Product Name/Title'), placeholder=_('e.g. VAM - Food Security Analysis'), value=data.im_product_name, error=errors.im_product_name, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_indicator_label %}
	{{ form.input('indicator_label', id='field-indicator-label', label=_('Indicator Label'), placeholder=_('e.g. Average price of carrots'), value=data.indicator_label, error=errors.indicator_label, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_indicator_code %}
	{{ form.input('indicator_code', id='field-indicator-code', label=_('Indicator Code'), placeholder=_('e.g. SYR-19-01'), value=data.indicator_code, error=errors.indicator_code, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_indicator_old_name %}
	{{ form.input('indicator_old_name', id='field-ind-old-name', label=_('Indicator Old Name'), placeholder=_('e.g. '), value=data.indicator_old_name, error=errors.indicator_old_name, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_unit_focal_point %}
	{{ form.input('unit_focal_point', id='field-unit-focal-point', label=_('Unit Focal Point'), placeholder=_('e.g. Secondary Data Review'), value=data.unit_focal_point, error=errors.unit_focal_point, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_sector %}
	{{ form.input('sector', id='field-sector', label=_('Sector'), placeholder=_('e.g. Food security; Nutrition; Health'), value=data.sector, error=errors.sector, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_data_sources %}
	{{ form.input('data_sources', id='field-data-sources', label=_('Data Sources'), placeholder=_('e.g. WFP on line VAM http://dataviz.vam.wfp.org/economic_explorer/prices?adm0=238'), value=data.data_sources, error=errors.data_sources, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_frequency_of_update %}
	{{ form.input('frequency_of_update', id='field-freq-of-update', label=_('Frequency Of Update'), placeholder=_('e.g. Other'), value=data.frequency_of_update, error=errors.frequency_of_update, classes=['control-full'], is_required=False) }}
    {% endblock %}


    {% block basic_fields_analytical_value %}
	{{ form.input('analytical_value', id='field-analytical-value', label=_('Analytical Value'), placeholder=_('e.g. Risk'), value=data.analytical_value, error=errors.analytical_value, classes=['control-full'], is_required=False) }}
    {% endblock %}

    {% block basic_fields_indicator_type %}
	{{ form.input('indicator_type', id='field-ind-type', label=_('Indicator Type'), placeholder=_('e.g. Quantitative'), value=data.indicator_type, error=errors.indicator_type, classes=['control-full'], is_required=False) }}
    {% endblock %}



    {{ form.select('theme', label=_('Theme'), options=theme_options, error=errors.theme, selected=theme, is_required=True) }}
    {{ form.select('sub_theme', label=_('Sub-Theme'), options=sub_theme_options, error=errors.theme, selected=sub_theme, is_required=True) }}
    


    {# Research question start #}

    {{ form.selectmulti('research_question', label=_('Research question'), options=rq_options, selected=selected_rq, id='field-research_question', error=errors.research_question, attrs={"multiple": "multiple", "data-module": "autocomplete"}, classes=['control-medium']) }}

    {# Research question end #}

    {% snippet 'package/snippets/resource_schema.html', data=data, errors=errors, licenses=licenses, entity_type=entity_type, object_type=object_type %}
    {% snippet 'package/snippets/validation_options.html', data=data, errors=errors, licenses=licenses, entity_type=entity_type, object_type=object_type %}

    <input type="hidden" name="validation_status" value="{{ data['validation_status'] }}" />
    <input type="hidden" name="validation_timestamp" value="{{ data['validation_timestamp'] }}" />

    {{ form.required_message() }}
  {% endblock basic_fields %}

  {% block metadata_fields %}
    {% if include_metadata %}
      {# TODO: Where do these come from, they don't exist in /package/new_package_form.html #}
      {# {{ form.select('resource_type', id='field-type', label=_('Resource Type'), options=[{'value': 'empty', 'text': _('Select a typeâ€¦')}], selected="empty", error=errors.type) }} #}

      {{ form.input('last_modified', id='field-last-modified', label=_('Last Modified'), placeholder=_('eg. 2012-06-05'), value=data.last_modified, error=errors.last_modified, classes=[]) }}

      {{ form.input('size', id='field-size', label=_('File Size'), placeholder=_('eg. 1024'), value=data.size, error=errors.size, classes=[]) }}

      {{ form.input('mimetype', id='field-mimetype', label=_('MIME Type'), placeholder=_('eg. application/json'), value=data.mimetype, error=errors.mimetype, classes=[]) }}

      {{ form.input('mimetype_inner', id='field-mimetype-inner', label=_('MIME Type'), placeholder=_('eg. application/json'), value=data.mimetype_inner, error=errors.mimetype_inner, classes=[]) }}
    {% endif %}
  {% endblock %}

  <div class="form-actions">
    {% block delete_button %}
      {% if data.id %}
        {% if h.check_access('resource_delete', {'id': data.id})  %}
          <a class="btn btn-danger pull-left" href="{% url_for controller='package', action='resource_delete', resource_id=data.id, id=pkg_name %}" data-module="confirm-action" data-module-content="{{ _('Are you sure you want to delete this resource?') }}">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a>
        {% endif %}
      {% endif %}
    {% endblock %}
    {% if stage %}
      {% block previous_button %}
        <button class="btn btn-default" name="save" value="go-dataset" type="submit">{{ _('Previous') }}</button>
      {% endblock %}
      {% block again_button %}
        <button class="btn btn-default" name="save" value="again" type="submit">{{ _('Save & add another') }}</button>
        {% endblock %}
      {% block save_button %}
      <button class="btn btn-primary" name="save" value="go-metadata" type="submit">{% block save_button_text %}{{ _('Finish') }}{% endblock %}</button>
      {% endblock %}
    {% else %}
      {% block add_button %}
      <button class="btn btn-primary" name="save" value="go-dataset-complete" type="submit">{{ _('Add') }}</button>
      {% endblock %}
    {% endif %}
  </div>
</form>
